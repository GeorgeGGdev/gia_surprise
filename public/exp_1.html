<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Experiencia 1</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap" rel="stylesheet">
</head>
<body>
    <audio id="backgroundMusic" loop autoplay>
        <source src="media/audio/milobg.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <div class="container">
        <div class="question" id="mainText">
            <span class="word word1">Hoy</span>
            <span class="word word2">es...</span>
        </div>
    </div>

    <!-- Contenedor para las im√°genes flotantes -->
    <div class="floating-images" id="floatingImages"></div>

    <canvas id="confetti-canvas"></canvas>
    <canvas id="sparkles-canvas"></canvas>

    <script>
        let currentStep = 1;
        let confettiCanvas, confettiCtx, confettiParticles = [], confettiAnimationId;
        let sparklesCanvas, sparklesCtx, sparklesParticles = [], sparklesAnimationId;
        const images = [
            { src: 'media/img/p_omar_g_1.png', side: 'right' },
            { src: 'media/img/cook_g_2.png', side: 'left' },
            { src: 'media/img/a_plaza_l_1.png', side: 'right' }
        ];

        // Asegurar que el audio se reproduzca
        window.addEventListener('load', function() {
            const audio = document.getElementById('backgroundMusic');
            
            // Intentar reproducir autom√°ticamente
            audio.play().catch(function(error) {
                console.log('Autoplay bloqueado, esperando interacci√≥n del usuario');
                
                // Si el autoplay est√° bloqueado, reproducir en la primera interacci√≥n
                document.addEventListener('click', function() {
                    audio.play();
                }, { once: true });
                
                document.addEventListener('touchstart', function() {
                    audio.play();
                }, { once: true });
            });
            
            // Guardar referencia del audio en localStorage para otras p√°ginas
            localStorage.setItem('backgroundMusicPlaying', 'true');

            // Iniciar la secuencia de textos
            startTextSequence();
        });

        // Mantener el audio reproduci√©ndose al cambiar de p√°gina
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('backgroundMusicTime', document.getElementById('backgroundMusic').currentTime);
        });

        function startTextSequence() {
            // Despu√©s de 3 segundos, cambiar a "3 febrero!!!!"
            setTimeout(() => {
                document.getElementById('mainText').innerHTML = `
                    <span class="word date-word1">3</span>
                    <span class="word date-word2">febrero!!!!</span>
                `;
                startConfetti();
                
                // Despu√©s de otros 3 segundos, cambiar al mensaje final
                setTimeout(() => {
                    stopConfetti();
                    document.getElementById('mainText').innerHTML = `
                        <span class="word final-text">Un d√≠a como hoy hace 18 a√±os spawne√≥ una persona especial en este mundo...</span>
                    `;
                    
                    // Despu√©s de 4 segundos, iniciar la secuencia de im√°genes
                    setTimeout(() => {
                        startImageSequence();
                    }, 4000);
                }, 3000);
            }, 3000);
        }

        // Confetti Animation (reutilizado de welcome.html)
        function initConfetti() {
            confettiCanvas = document.getElementById('confetti-canvas');
            confettiCtx = confettiCanvas.getContext('2d');
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }

        function createConfettiParticle() {
            return {
                x: Math.random() < 0.5 ? -10 : window.innerWidth + 10,
                y: Math.random() * window.innerHeight,
                vx: Math.random() < 0.5 ? Math.random() * 3 + 1 : -(Math.random() * 3 + 1),
                vy: (Math.random() - 0.5) * 2,
                color: ['#E8D5FF', '#C8A8E9', '#B8F2E6', '#7FCDCD', '#FFB6C1', '#DDA0DD'][Math.floor(Math.random() * 6)],
                size: Math.random() * 8 + 4,
                rotation: Math.random() * 360,
                rotationSpeed: (Math.random() - 0.5) * 10
            };
        }

        function updateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            
            for (let i = confettiParticles.length - 1; i >= 0; i--) {
                let p = confettiParticles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.rotation += p.rotationSpeed;
                
                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.rotation * Math.PI / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                confettiCtx.restore();
                
                if (p.x < -20 || p.x > window.innerWidth + 20 || p.y < -20 || p.y > window.innerHeight + 20) {
                    confettiParticles.splice(i, 1);
                }
            }
            
            if (Math.random() < 0.3) {
                confettiParticles.push(createConfettiParticle());
            }
            
            confettiAnimationId = requestAnimationFrame(updateConfetti);
        }

        function startConfetti() {
            initConfetti();
            updateConfetti();
        }

        function stopConfetti() {
            if (confettiAnimationId) {
                cancelAnimationFrame(confettiAnimationId);
            }
            confettiParticles = [];
            if (confettiCtx) {
                confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            }
        }

        window.addEventListener('resize', () => {
            if (confettiCanvas) {
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
            if (sparklesCanvas) {
                sparklesCanvas.width = window.innerWidth;
                sparklesCanvas.height = window.innerHeight;
            }
        });

        // Secuencia de im√°genes
        function startImageSequence() {
            let imageIndex = 0;
            
            function showNextImage() {
                if (imageIndex < images.length) {
                    createFloatingImage(images[imageIndex], imageIndex);
                    imageIndex++;
                    setTimeout(showNextImage, 4000); // 4 segundos entre cada imagen
                } else {
                    // Despu√©s de que todas las im√°genes hayan pasado, mostrar texto final
                    setTimeout(() => {
                        document.getElementById('mainText').innerHTML = `
                            <span class="word reveal-text1">Esa persona...</span>
                        `;
                        
                        setTimeout(() => {
                            document.getElementById('mainText').innerHTML = `
                                <span class="word reveal-text2">¬°Eres t√∫!</span>
                            `;
                            
                            // Continuar con la nueva secuencia despu√©s de "¬°Eres t√∫!" (4 segundos en lugar de 3)
                            setTimeout(() => {
                                startNewTextSequence();
                            }, 4000);
                        }, 3000);
                    }, 2000);
                }
            }
            
            showNextImage();
        }

        function createFloatingImage(imageData, index) {
            const container = document.getElementById('floatingImages');
            const imgElement = document.createElement('img');
            
            imgElement.src = imageData.src;
            imgElement.className = `floating-img floating-img-${imageData.side}`;
            imgElement.style.animationDelay = '0s';
            
            container.appendChild(imgElement);
            
            // Iniciar efectos de part√≠culas para esta imagen
            startImageSparkles();
            
            // Remover la imagen despu√©s de la animaci√≥n
            setTimeout(() => {
                if (imgElement.parentNode) {
                    imgElement.parentNode.removeChild(imgElement);
                }
                if (index === images.length - 1) {
                    stopImageSparkles();
                }
            }, 8000);
        }

        // Sistema de destellos/sparkles
        function initSparkles() {
            sparklesCanvas = document.getElementById('sparkles-canvas');
            sparklesCtx = sparklesCanvas.getContext('2d');
            sparklesCanvas.width = window.innerWidth;
            sparklesCanvas.height = window.innerHeight;
        }

        function createSparkle() {
            return {
                x: Math.random() * window.innerWidth,
                y: window.innerHeight + 10,
                vx: (Math.random() - 0.5) * 2,
                vy: -Math.random() * 2 - 1,
                color: ['#FFD700', '#FFF8DC', '#FFFFE0', '#F0E68C'][Math.floor(Math.random() * 4)],
                size: Math.random() * 4 + 2,
                life: 1,
                decay: Math.random() * 0.02 + 0.01
            };
        }

        function updateSparkles() {
            sparklesCtx.clearRect(0, 0, sparklesCanvas.width, sparklesCanvas.height);
            
            for (let i = sparklesParticles.length - 1; i >= 0; i--) {
                let s = sparklesParticles[i];
                s.x += s.vx;
                s.y += s.vy;
                s.life -= s.decay;
                
                sparklesCtx.save();
                sparklesCtx.globalAlpha = s.life;
                sparklesCtx.fillStyle = s.color;
                sparklesCtx.beginPath();
                sparklesCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                sparklesCtx.fill();
                sparklesCtx.restore();
                
                if (s.life <= 0 || s.y < -10) {
                    sparklesParticles.splice(i, 1);
                }
            }
            
            if (Math.random() < 0.1) {
                sparklesParticles.push(createSparkle());
            }
            
            sparklesAnimationId = requestAnimationFrame(updateSparkles);
        }

        function startImageSparkles() {
            if (!sparklesAnimationId) {
                initSparkles();
                updateSparkles();
            }
        }

        function stopImageSparkles() {
            if (sparklesAnimationId) {
                cancelAnimationFrame(sparklesAnimationId);
                sparklesAnimationId = null;
            }
            sparklesParticles = [];
            if (sparklesCtx) {
                sparklesCtx.clearRect(0, 0, sparklesCanvas.width, sparklesCanvas.height);
            }
        }

        // Nueva secuencia de textos despu√©s de "¬°Eres t√∫!"
        function startNewTextSequence() {
            // Primer texto: "quiz√°s por casualidad... de esas coincidencias que..."
            document.getElementById('mainText').innerHTML = `
                <span class="word new-text1">Quiz√°s por casualidad... de esas coincidencias que...</span>
            `;
            
            setTimeout(() => {
                // Segundo texto: "llegan como brisa de verano..."
                document.getElementById('mainText').innerHTML = `
                    <span class="word new-text2">Llegan como brisa de verano...</span>
                `;
                
                setTimeout(() => {
                    // Tercer texto: "tan c√°lida y abrazadora que es imposible no sonre√≠r..."
                    document.getElementById('mainText').innerHTML = `
                        <span class="word new-text3">Tan c√°lida y abrazadora que es imposible no sonre√≠r...</span>
                    `;
                    
                    setTimeout(() => {
                        // Texto fijo + texto cambiante
                        startFinalSequence();
                    }, 4000);
                }, 4000);
            }, 4000);
        }

        function startFinalSequence() {
            document.getElementById('mainText').innerHTML = `
                <div class="final-sequence">
                    <span class="word fixed-text">Imposible no...</span>
                    <span class="word changing-text" id="changingText">notarla</span>
                </div>
            `;
            
            const changingWords = ['notarla', 'mirarla', 'buscarla', 'elegirla', 'cuidarla', 'celebrarla'];
            let wordIndex = 0;
            let intervalId;
            let cycleCount = 0;
            
            const changeWord = () => {
                wordIndex = (wordIndex + 1) % changingWords.length;
                document.getElementById('changingText').textContent = changingWords[wordIndex];
                
                // Si llegamos a "celebrarla", pausar por m√°s tiempo
                if (changingWords[wordIndex] === 'celebrarla') {
                    cycleCount++;
                    clearInterval(intervalId);
                    
                    if (cycleCount >= 2) {
                        // Despu√©s de 2 ciclos, continuar con la nueva secuencia
                        setTimeout(() => {
                            startMemorySequence();
                        }, 3000);
                    } else {
                        setTimeout(() => {
                            intervalId = setInterval(changeWord, 1000);
                        }, 3000);
                    }
                }
            };
            
            // Cambiar palabra cada segundo
            intervalId = setInterval(changeWord, 1000);
        }

        // Nueva secuencia de recuerdos
        function startMemorySequence() {
            fadeOutText(() => {
                document.getElementById('mainText').innerHTML = `
                    <span class="word memory-text1">Como ese verano inolvidable que de ni√±os viv√≠amos...</span>
                `;
                fadeInText();
                
                setTimeout(() => {
                    fadeOutText(() => {
                        document.getElementById('mainText').innerHTML = `
                            <span class="word memory-text2">Donde sonre√≠amos sin raz√≥n...</span>
                        `;
                        fadeInText();
                        
                        setTimeout(() => {
                            startEmotionSequence();
                        }, 4000);
                    });
                }, 4000);
            });
        }

        function startEmotionSequence() {
            fadeOutText(() => {
                document.getElementById('mainText').innerHTML = `
                    <div class="final-sequence">
                        <span class="word fixed-text">Inolvidable como...</span>
                        <span class="word changing-text" id="emotionText">tu risa</span>
                    </div>
                `;
                fadeInText();
                
                const emotionWords = ['tu risa', 'tu hablar', 'tus gestos', 'tu llanto'];
                let emotionIndex = 0;
                
                const changeEmotion = () => {
                    emotionIndex++;
                    if (emotionIndex < emotionWords.length) {
                        document.getElementById('emotionText').textContent = emotionWords[emotionIndex];
                        setTimeout(changeEmotion, 1500);
                    } else {
                        // Despu√©s del √∫ltimo, continuar con "pues esa es..."
                        setTimeout(() => {
                            startFinalReveal();
                        }, 2000);
                    }
                };
                
                setTimeout(changeEmotion, 1500);
            });
        }

        function startFinalReveal() {
            fadeOutText(() => {
                document.getElementById('mainText').innerHTML = `
                    <span class="word final-reveal1">Pues esa es...</span>
                `;
                fadeInText();
                
                setTimeout(() => {
                    fadeOutText(() => {
                        document.getElementById('mainText').innerHTML = `
                            <span class="word final-reveal2">La maravilla de que existas ‚ô°...</span>
                        `;
                        fadeInText();
                        
                        // Despu√©s de 3 segundos, iniciar la nueva secuencia de im√°genes
                        setTimeout(() => {
                            startFinalImageSequence();
                        }, 3000);
                    });
                }, 3000);
            });
        }

        // Nueva secuencia de im√°genes finales
        function startFinalImageSequence() {
            const finalImages = [
                { src: 'media/img/a_plaza_g_1.png', side: 'right' },
                { src: 'media/img/roblox_1.png', side: 'left' },
                { src: 'media/img/vid_omar2.mp4', side: 'right' },
                { src: 'media/img/gia_smile.png', side: 'left' },
                { src: 'media/img/roblox_3.png', side: 'right' },
                { src: 'media/img/invento1.png', side: 'left' }
            ];
            
            let imageIndex = 0;
            
            function showNextFinalImage() {
                if (imageIndex < finalImages.length) {
                    createSlowFloatingImage(finalImages[imageIndex], imageIndex);
                    imageIndex++;
                    setTimeout(showNextFinalImage, 2500); // M√°s pegadas (2.5 segundos)
                } else {
                    // Despu√©s de todas las im√°genes, continuar con la nueva secuencia
                    setTimeout(() => {
                        startImpactSequence();
                    }, 3000);
                }
            }
            
            showNextFinalImage();
        }

        function createSlowFloatingImage(imageData, index) {
            const container = document.getElementById('floatingImages');
            const element = document.createElement(imageData.src.endsWith('.mp4') ? 'video' : 'img');
            
            element.src = imageData.src;
            if (element.tagName === 'VIDEO') {
                element.autoplay = true;
                element.muted = true;
                element.loop = true;
            }
            
            element.className = `floating-img-slow floating-img-${imageData.side}`;
            element.style.animationDelay = '0s';
            
            container.appendChild(element);
            
            // Iniciar efectos de part√≠culas
            startImageSparkles();
            
            // Remover despu√©s de la animaci√≥n (m√°s lenta)
            setTimeout(() => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
                if (index === finalImages.length - 1) {
                    stopImageSparkles();
                }
            }, 12000); // 12 segundos para animaci√≥n m√°s lenta
        }

        // Nueva secuencia de impacto y videos
        function startImpactSequence() {
            fadeOutText(() => {
                document.getElementById('mainText').innerHTML = `
                    <span class="word impact-text1">Porque ese es el impacto que haces...</span>
                `;
                fadeInText();
                
                setTimeout(() => {
                    fadeOutText(() => {
                        document.getElementById('mainText').innerHTML = `
                            <span class="word impact-text2">Y por eso algunos mensajes...</span>
                        `;
                        fadeInText();
                        
                        setTimeout(() => {
                            startVideoSequence();
                        }, 3000);
                    });
                }, 4000);
            });
        }

        function startVideoSequence() {
            // Ocultar texto y mostrar primer video
            fadeOutText(() => {
                document.getElementById('mainText').style.display = 'none';
                showVideo('media/msg/uziel_vid.mp4', () => {
                    // Despu√©s del primer video, mostrar el segundo
                    showVideo('media/msg/melany_vid.mp4', () => {
                        // Despu√©s del segundo video, continuar
                        document.getElementById('mainText').style.display = 'block';
                        document.getElementById('mainText').innerHTML = `
                            <span class="word missing-text">Y faltaron muchos m√°s...</span>
                        `;
                        fadeInText();
                        
                        setTimeout(() => {
                            startCollageSequence();
                        }, 3000);
                    });
                });
            });
        }

        function showVideo(videoSrc, callback) {
            const container = document.getElementById('floatingImages');
            const video = document.createElement('video');
            
            video.src = videoSrc;
            video.autoplay = true;
            video.muted = false; // Permitir audio en estos videos
            video.controls = false;
            video.className = 'fullscreen-video';
            
            container.appendChild(video);
            
            video.addEventListener('ended', () => {
                container.removeChild(video);
                callback();
            });
        }

        // Secuencia de collage final
        function startCollageSequence() {
            fadeOutText(() => {
                // Obtener todas las im√°genes para el collage
                const allImages = [
                    'p_omar_g_1.png', 'cook_g_2.png', 'a_plaza_l_1.png', 'a_plaza_g_1.png',
                    'roblox_1.png', 'gia_smile.png', 'roblox_3.png', 'invento1.png'
                ];
                
                createCollage(allImages);
                startCelebrationEffects();
                
                setTimeout(() => {
                    document.getElementById('mainText').innerHTML = `
                        <div class="final-celebration">
                            <span class="word celebration-text">¬øLista para celebrar?</span>
                            <button class="btn btn-celebrate" onclick="goToGame()">¬°Vamos! üéâ</button>
                        </div>
                    `;
                    document.getElementById('mainText').style.display = 'block';
                    fadeInText();
                }, 3000);
            });
        }

        function createCollage(imageList) {
            const container = document.getElementById('floatingImages');
            
            imageList.forEach((imageName, index) => {
                setTimeout(() => {
                    const img = document.createElement('img');
                    img.src = `media/img/${imageName}`;
                    img.className = 'collage-img';
                    
                    // Posici√≥n aleatoria
                    img.style.left = Math.random() * (window.innerWidth - 150) + 'px';
                    img.style.top = Math.random() * (window.innerHeight - 150) + 'px';
                    img.style.transform = `rotate(${Math.random() * 60 - 30}deg) scale(${Math.random() * 0.5 + 0.5})`;
                    
                    container.appendChild(img);
                }, index * 300);
            });
        }

        function startCelebrationEffects() {
            startConfetti();
            startImageSparkles();
            startHearts();
        }

        // Sistema de corazones
        let heartsCanvas, heartsCtx, heartsParticles = [], heartsAnimationId;

        function startHearts() {
            heartsCanvas = document.createElement('canvas');
            heartsCanvas.id = 'hearts-canvas';
            heartsCanvas.style.position = 'fixed';
            heartsCanvas.style.top = '0';
            heartsCanvas.style.left = '0';
            heartsCanvas.style.width = '100%';
            heartsCanvas.style.height = '100%';
            heartsCanvas.style.pointerEvents = 'none';
            heartsCanvas.style.zIndex = '15';
            document.body.appendChild(heartsCanvas);
            
            heartsCtx = heartsCanvas.getContext('2d');
            heartsCanvas.width = window.innerWidth;
            heartsCanvas.height = window.innerHeight;
            
            updateHearts();
        }

        function createHeart() {
            return {
                x: Math.random() * window.innerWidth,
                y: window.innerHeight + 20,
                vx: (Math.random() - 0.5) * 2,
                vy: -Math.random() * 3 - 1,
                size: Math.random() * 15 + 10,
                color: ['#FF69B4', '#FFB6C1', '#DDA0DD', '#E8D5FF'][Math.floor(Math.random() * 4)],
                life: 1,
                decay: Math.random() * 0.01 + 0.005
            };
        }

        function drawHeart(ctx, x, y, size, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x, y + size/4);
            ctx.bezierCurveTo(x, y, x - size/2, y, x - size/2, y + size/4);
            ctx.bezierCurveTo(x - size/2, y + size/2, x, y + size*3/4, x, y + size);
            ctx.bezierCurveTo(x, y + size*3/4, x + size/2, y + size/2, x + size/2, y + size/4);
            ctx.bezierCurveTo(x + size/2, y, x, y, x, y + size/4);
            ctx.fill();
        }

        function updateHearts() {
            heartsCtx.clearRect(0, 0, heartsCanvas.width, heartsCanvas.height);
            
            for (let i = heartsParticles.length - 1; i >= 0; i--) {
                let h = heartsParticles[i];
                h.x += h.vx;
                h.y += h.vy;
                h.life -= h.decay;
                
                heartsCtx.save();
                heartsCtx.globalAlpha = h.life;
                drawHeart(heartsCtx, h.x, h.y, h.size, h.color);
                heartsCtx.restore();
                
                if (h.life <= 0 || h.y < -50) {
                    heartsParticles.splice(i, 1);
                }
            }
            
            if (Math.random() < 0.1) {
                heartsParticles.push(createHeart());
            }
            
            heartsAnimationId = requestAnimationFrame(updateHearts);
        }

        function goToGame() {
            window.location.href = 'game.html';
        }

        // Funciones de fade
        function fadeOutText(callback) {
            const mainText = document.getElementById('mainText');
            mainText.style.transition = 'opacity 1s ease-out';
            mainText.style.opacity = '0';
            setTimeout(callback, 1000);
        }

        function fadeInText() {
            const mainText = document.getElementById('mainText');
            setTimeout(() => {
                mainText.style.opacity = '1';
            }, 100);
        }
    </script>
</body>
</html>